<% change_layout = RefinerySetting.find_or_set(:change_page_layout, false)  %>
<% change_layout = false if @page.respond_to? (:new_record?) and @page.new_record?  %>
<% if RefinerySetting.find_or_set(:new_page_parts, false) %>
  <ul id="page_parts_controls">
    <li>
      <%= link_to refinery_icon_tag('add.png'), '#',
                  :id => 'add_page_part',
                  :title => t('.create_content_section') %>
    </li>
    <li>
      <%= link_to refinery_icon_tag('delete.png'), '#',
                  :title => t('.delete_content_section'),
                  :class => 'delete_page_part',
                  :name => t('.delete_content_section'),
                  :id => 'delete_page_part' %>
    </li>
  </ul>
<% end %>
<div id='page-tabs' class='clearfix ui-tabs ui-widget ui-widget-content ui-corner-all'>
  <ul id='page_parts'>
  <% @page.parts.each_with_index do |part, part_index| %>
    <li class='ui-state-default<%= ' ui-state-active' if part_index == 0 %>'>
      <% if change_layout %>
        <%= link_to t("page_layouts.#{@page.try(:layout).try(:name)}.#{part.name}", :default => part.name.titleize), "##{@page.new_record? ? "page_part_new_#{part_index}" : part.to_param}" %>
      <% else %>
        <%= link_to part.name.titleize, "##{@page.persisted? ? "page_part_new_#{part_index}" : part.to_param}" %>
      <% end %>
    </li>
  <% end %>
  <% Refinery::Pages.tabs.each_with_index do |tab, tab_index| %>
    <li class='ui-state-default' id="custom_<%= tab.name %>_tab">
      <%= link_to tab.name.titleize, "#custom_tab_#{tab_index}" %>
    </li>
  <% end %>
  <% if change_layout %>
    <li class='ui-state-default' style="float:right;">
      <%= link_to 'Layout', '#', :id => 'change_layout' %>
    </li>
  <% end %>
  </ul>

  <div id='page_part_editors'>
    <% part_index = -1 %>
    <%= f.fields_for :parts do |p| %>
      <%= render :partial => 'page_part_field',
                 :locals => {
                   :part => p.object,
                   :part_index => (part_index += 1),
                   :new_part => !@page.persisted?
                 } -%>
    <% end %>
    <% if change_layout %>
      <div class="dialog" id="page_layout_dialog" style="display:none">
      <input id="authenticity_token" type="hidden" value="<%= form_authenticity_token() %>">

        <div style="width:100%; border: 1px solid grey; background-color: #f2f2f2; height:auto;" class="clearfix">
          <p class="field">
            <%= @page.has_layout? == true ? "The current layout is <strong>#{@page.layout.name}</strong>" : "The page has no layout set." %>
          </p>
          <p>
            Change it to
            <select id="page_layout_picker">
              <%= options_for_select((PageLayout.all.collect {|layout| [layout.name.titleize, layout.name] }).unshift(['None', nil]),
                                     (@page.has_layout? == true ? @page.layout.name : nil)) %>
            </select>
          </p>
          <div id="page_layout_migration">
            <h3>Original parts</h3>
            <ul id="page_layout_migrate_from" class="migrate_box"></ul>
            <h3>Selected layout</h3>
            <div id="page_layout_migrate_to"></div>
          </div>

          <button id="page_layout_commit_change" class="clearfix">Commit layout change</button>
        </div>
    <% end %>
    <% Refinery::Pages.tabs.each_with_index do |tab, tab_index| %>
      <div class='page_part' id='<%= "custom_tab_#{tab_index}" %>'>
        <%= render :partial => tab.partial, :locals => {:f => f} %>
      </div>
    <% end %>
  </div>
</div>
